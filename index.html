<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1a8f4b" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>山手線 駅看板 PWA</title>
  <style>
    :root{
      --jr-green:#1a8f4b;
      --bg:#0b0f14;
      --panel:#0f1722;
      --text:#e8eef6;
      --muted:#a7b3c4;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100svh;
      background: radial-gradient(1200px 700px at 50% -10%, #19334a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* 駅看板 */
    .sign{
      background: linear-gradient(180deg, #0f1c2a 0%, var(--panel) 100%);
      border: 1px solid #1d2a3a;
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .sign::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:18px;
      background: linear-gradient(90deg, rgba(26,143,75,.35), rgba(26,143,75,0));
      pointer-events:none;
      opacity:.7;
    }

    .jrbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      position:relative;
      z-index:1;
    }
    .jrlogo{
      display:flex; align-items:center; gap:8px;
      font-weight:700;
      letter-spacing:.02em;
      color:#dff6ea;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--jr-green);
      box-shadow: 0 0 0 3px rgba(26,143,75,.18);
    }
    .badge{
      font-size:12px;
      color: #d7ffe6;
      background: rgba(26,143,75,.18);
      border: 1px solid rgba(26,143,75,.35);
      padding:6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .stationname{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 6px 2px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .jp{
      font-size:44px;
      font-weight:800;
      line-height:1.05;
      letter-spacing:.02em;
    }
    /* 駅名のひらがな（小さめ） */
    .kana{
      font-size:16px;
      color: #b9d6c7;
      letter-spacing: .12em;
      margin-top: -6px;
      font-weight: 650;
    }
    .romaji{
      color: var(--muted);
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:14px;
    }

    .linebar{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      gap:12px;
      padding-top:12px;
    }
    .linechip{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight:700;
      white-space:nowrap;
    }
    .ring{
      width:14px; height:14px; border-radius:999px;
      border: 3px solid var(--jr-green);
      box-shadow: 0 0 0 3px rgba(26,143,75,.12);
    }
    .nextbox{
      margin-left:auto;
      text-align:right;
    }
    .nextlabel{
      font-size:11px; color: var(--muted);
    }
    .nextstation{
      font-weight:800;
      font-size:15px;
      margin-top:2px;
    }

    /* 乗り換え案内 */
    .transfer{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .transfer h2{
      margin:0 0 10px;
      font-size:13px;
      color:#d8e3f2;
      letter-spacing:.06em;
    }
    .lines{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    /* pill内で2行表示できるようにする */
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color:#e9f1fb;
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.1;
      min-width: fit-content;
    }
    .pill.muted{
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
    /* 路線のひらがな（さらに小さめ） */
    .line-kana{
      font-size:10px;
      color:#9fb7aa;
      letter-spacing:.1em;
    }

    /* コントロール */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .btnrow{
      display:flex;
      gap:10px;
      flex: 1 1 auto;
    }
    button{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      color:#07110b;
      background: linear-gradient(180deg, #46d686 0%, #1a8f4b 100%);
      box-shadow: 0 14px 35px rgba(26,143,75,.25);
      cursor:pointer;
      flex: 1 1 120px;
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      box-shadow:none;
      font-weight:750;
    }
    button:active{ transform: translateY(1px); }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      flex: 0 0 auto;
      user-select:none;
    }
    .toggle input{ width:18px; height:18px; }
    .footer{
      color: rgba(255,255,255,.35);
      font-size:12px;
      text-align:center;
      padding-top:4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sign" role="img" aria-label="駅の看板">
      <div class="jrbar">
        <div class="jrlogo"><span class="dot"></span> JR EAST</div>
        <div class="badge" id="directionBadge">外回り（時計回り）</div>
      </div>

      <div class="stationname">
        <div class="jp" id="stationJp">東京</div>
        <div class="kana" id="stationKana">とうきょう</div>
        <div class="romaji" id="stationRo">TOKYO</div>
      </div>

      <div class="linebar">
        <div class="linechip"><span class="ring"></span> 山手線</div>
        <div class="nextbox">
          <div class="nextlabel">Next</div>
          <div class="nextstation" id="nextStation">有楽町</div>
        </div>
      </div>
    </div>

    <div class="transfer">
      <h2>乗り換え案内</h2>
      <div class="lines" id="transferLines"></div>
    </div>

    <div class="controls">
      <div class="btnrow">
        <button id="nextBtn">次の駅</button>
        <button class="secondary" id="randomBtn">ランダム</button>
      </div>

      <label class="toggle" title="進行方向を切り替え">
        <input type="checkbox" id="dirToggle" />
        <span id="dirText">外回り</span>
      </label>
    </div>

    <div class="footer">オフライン対応 / ホーム画面に追加できます（音はボタン押下で再生）</div>
  </div>

  <script>
    // ===== 駅データ =====
    // transfer は {name,kana} の配列。未設定の場合は "—"。
    const yamanote = [
      {
        jp:"東京", kana:"とうきょう", ro:"TOKYO",
        transfer:[
          {name:"丸ノ内線", kana:"まるのうちせん"},
          {name:"中央線", kana:"ちゅうおうせん"},
          {name:"京葉線", kana:"けいようせん"},
          {name:"東海道新幹線", kana:"とうかいどうしんかんせん"},
          {name:"東北・北海道新幹線", kana:"とうほく・ほっかいどうしんかんせん"},
          {name:"上越新幹線", kana:"じょうえつしんかんせん"},
          {name:"北陸新幹線", kana:"ほくりくしんかんせん"}
        ],
        sound:"./sounds/tokyo.mp3" // 任意（無くてもOK）
      },
      { jp:"有楽町", kana:"ゆうらくちょう", ro:"YURAKUCHO", transfer:[ {name:"有楽町線", kana:"ゆうらくちょうせん"}, {name:"日比谷線（徒歩圏）", kana:"ひびやせん"} ] },
      { jp:"新橋", kana:"しんばし", ro:"SHIMBASHI", transfer:[ {name:"銀座線", kana:"ぎんざせん"}, {name:"浅草線", kana:"あさくさせん"}, {name:"ゆりかもめ", kana:"ゆりかもめ"} ] },
      { jp:"浜松町", kana:"はままつちょう", ro:"HAMAMATSUCHO", transfer:[ {name:"東京モノレール", kana:"とうきょうものれーる"}, {name:"大江戸線（大門）", kana:"おおえどせん（だいもん）"} ] },
      { jp:"田町", kana:"たまち", ro:"TAMACHI", transfer:[ {name:"三田線（三田）", kana:"みたせん（みた）"}, {name:"浅草線（三田）", kana:"あさくさせん（みた）"} ] },
      { jp:"高輪ゲートウェイ", kana:"たかなわげーとうぇい", ro:"TAKANAWA GATEWAY", transfer:[ {name:"京浜東北線", kana:"けいひんとうほくせん"} ] },
      { jp:"品川", kana:"しながわ", ro:"SHINAGAWA", transfer:[ {name:"東海道新幹線", kana:"とうかいどうしんかんせん"}, {name:"京急線", kana:"けいきゅうせん"}, {name:"横須賀線", kana:"よこすかせん"}, {name:"京浜東北線", kana:"けいひんとうほくせん"} ] },
      { jp:"大崎", kana:"おおさき", ro:"OSAKI", transfer:[ {name:"りんかい線", kana:"りんかいせん"}, {name:"湘南新宿ライン", kana:"しょうなんしんじゅくらいん"} ] },
      { jp:"五反田", kana:"ごたんだ", ro:"GOTANDA", transfer:[ {name:"浅草線", kana:"あさくさせん"}, {name:"東急池上線", kana:"とうきゅういけがみせん"} ] },
      { jp:"目黒", kana:"めぐろ", ro:"MEGURO", transfer:[ {name:"南北線", kana:"なんぼくせん"}, {name:"三田線", kana:"みたせん"}, {name:"東急目黒線", kana:"とうきゅうめぐろせん"} ] },
      { jp:"恵比寿", kana:"えびす", ro:"EBISU", transfer:[ {name:"日比谷線", kana:"ひびやせん"} ] },
      {
        jp:"渋谷", kana:"しぶや", ro:"SHIBUYA",
        transfer:[
          {name:"銀座線", kana:"ぎんざせん"},
          {name:"半蔵門線", kana:"はんぞうもんせん"},
          {name:"副都心線", kana:"ふくとしんせん"},
          {name:"東急東横線", kana:"とうきゅうとうよこせん"},
          {name:"田園都市線", kana:"でんえんとしせん"},
          {name:"井の頭線", kana:"いのかしらせん"}
        ],
        sound:"./sounds/shibuya.mp3" // 任意（無くてもOK）
      },
      { jp:"原宿", kana:"はらじゅく", ro:"HARAJUKU", transfer:[ {name:"千代田線（明治神宮前）", kana:"ちよだせん（めいじじんぐうまえ）"}, {name:"副都心線（明治神宮前）", kana:"ふくとしんせん（めいじじんぐうまえ）"} ] },
      { jp:"代々木", kana:"よよぎ", ro:"YOYOGI", transfer:[ {name:"大江戸線", kana:"おおえどせん"}, {name:"中央・総武線", kana:"ちゅうおう・そうぶせん"} ] },
      {
        jp:"新宿", kana:"しんじゅく", ro:"SHINJUKU",
        transfer:[
          {name:"丸ノ内線", kana:"まるのうちせん"},
          {name:"副都心線", kana:"ふくとしんせん"},
          {name:"都営新宿線", kana:"とえいしんじゅくせん"},
          {name:"大江戸線", kana:"おおえどせん"},
          {name:"小田急線", kana:"おだきゅうせん"},
          {name:"京王線", kana:"けいおうせん"}
        ],
        sound:"./sounds/shinjuku.mp3" // 任意（無くてもOK）
      },
      { jp:"新大久保", kana:"しんおおくぼ", ro:"SHIN-OKUBO", transfer:["—"] },
      { jp:"高田馬場", kana:"たかだのばば", ro:"TAKADANOBABA", transfer:[ {name:"東西線", kana:"とうざいせん"}, {name:"西武新宿線", kana:"せいぶしんじゅくせん"} ] },
      { jp:"目白", kana:"めじろ", ro:"MEJIRO", transfer:["—"] },
      { jp:"池袋", kana:"いけぶくろ", ro:"IKEBUKURO", transfer:[ {name:"丸ノ内線", kana:"まるのうちせん"}, {name:"有楽町線", kana:"ゆうらくちょうせん"}, {name:"副都心線", kana:"ふくとしんせん"}, {name:"東武東上線", kana:"とうぶとうじょうせん"}, {name:"西武池袋線", kana:"せいぶいけぶくろせん"} ] },
      { jp:"大塚", kana:"おおつか", ro:"OTSUKA", transfer:[ {name:"都電荒川線", kana:"とでんあらかわせん"} ] },
      { jp:"巣鴨", kana:"すがも", ro:"SUGAMO", transfer:[ {name:"三田線", kana:"みたせん"} ] },
      { jp:"駒込", kana:"こまごめ", ro:"KOMAGOME", transfer:[ {name:"南北線", kana:"なんぼくせん"} ] },
      { jp:"田端", kana:"たばた", ro:"TABATA", transfer:[ {name:"京浜東北線", kana:"けいひんとうほくせん"} ] },
      { jp:"西日暮里", kana:"にしにっぽり", ro:"NISHI-NIPPORI", transfer:[ {name:"千代田線", kana:"ちよだせん"}, {name:"日暮里・舎人ライナー", kana:"にっぽり・とねりらいなー"} ] },
      { jp:"日暮里", kana:"にっぽり", ro:"NIPPORI", transfer:[ {name:"京成本線", kana:"けいせいほんせん"}, {name:"日暮里・舎人ライナー", kana:"にっぽり・とねりらいなー"} ] },
      { jp:"鶯谷", kana:"うぐいすだに", ro:"UGUISUDANI", transfer:["—"] },
      { jp:"上野", kana:"うえの", ro:"UENO", transfer:[ {name:"銀座線", kana:"ぎんざせん"}, {name:"日比谷線", kana:"ひびやせん"}, {name:"京成本線", kana:"けいせいほんせん"}, {name:"東北・北海道新幹線", kana:"とうほく・ほっかいどうしんかんせん"}, {name:"上越新幹線", kana:"じょうえつしんかんせん"}, {name:"北陸新幹線", kana:"ほくりくしんかんせん"} ] },
      { jp:"御徒町", kana:"おかちまち", ro:"OKACHIMACHI", transfer:[ {name:"大江戸線（上野御徒町）", kana:"おおえどせん（うえのおかちまち）"}, {name:"銀座線（上野広小路）", kana:"ぎんざせん（うえのひろこうじ）"}, {name:"日比谷線（仲御徒町）", kana:"ひびやせん（なかおかちまち）"} ] },
      { jp:"秋葉原", kana:"あきはばら", ro:"AKIHABARA", transfer:[ {name:"日比谷線", kana:"ひびやせん"}, {name:"つくばエクスプレス", kana:"つくばえくすぷれす"}, {name:"中央・総武線", kana:"ちゅうおう・そうぶせん"} ] },
      { jp:"神田", kana:"かんだ", ro:"KANDA", transfer:[ {name:"銀座線", kana:"ぎんざせん"}, {name:"中央線", kana:"ちゅうおうせん"} ] }
    ];

    let idx = 0;
    let clockwise = true; // 外回り（時計回り）

    const elJp = document.getElementById("stationJp");
    const elKana = document.getElementById("stationKana");
    const elRo = document.getElementById("stationRo");
    const elNext = document.getElementById("nextStation");
    const elLines = document.getElementById("transferLines");
    const badge = document.getElementById("directionBadge");

    // ====== A: 汎用音（必須）======
    const genericSound = new Audio("./sounds/depart.mp3");
    genericSound.volume = 0.6;

    // ====== B: 駅別音（任意）======
    const soundCache = new Map();
    function getSound(url){
      if(!url) return null;
      if(soundCache.has(url)) return soundCache.get(url);
      const a = new Audio(url);
      a.volume = 0.6;
      soundCache.set(url, a);
      return a;
    }

    function playDepartSound(){
      const cur = yamanote[idx];
      const stationAudio = cur.sound ? getSound(cur.sound) : null;
      const audio = stationAudio || genericSound;

      try{
        audio.currentTime = 0;
        // iOSはユーザー操作がトリガーでないと弾く場合あり → catchで握りつぶし
        audio.play().catch(()=>{});
      }catch(_e){}
    }

    function isDash(x){
      return x === "—" || x === "-" || x === "ー";
    }

    function normalizeTransfer(list){
      if(!list || list.length === 0) return ["—"];
      return list;
    }

    function render(){
      const cur = yamanote[idx];

      elJp.textContent = cur.jp;
      elKana.textContent = cur.kana || "";
      elRo.textContent = cur.ro;

      const nextIdx = clockwise
        ? (idx + 1) % yamanote.length
        : (idx - 1 + yamanote.length) % yamanote.length;
      elNext.textContent = yamanote[nextIdx].jp;

      // 乗り換え表示
      elLines.innerHTML = "";
      const lines = normalizeTransfer(cur.transfer);

      lines.forEach(line => {
        const span = document.createElement("span");

        // 旧形式（"—" など文字列）も許容
        if(typeof line === "string"){
          span.className = "pill" + (isDash(line) ? " muted" : "");
          span.textContent = line;
          elLines.appendChild(span);
          return;
        }

        // {name,kana} 形式
        const name = (line && line.name) ? line.name : "—";
        const kana = (line && line.kana) ? line.kana : "";
        span.className = "pill" + (isDash(name) ? " muted" : "");

        const top = document.createElement("div");
        top.textContent = name;

        span.appendChild(top);

        if(kana && !isDash(name)){
          const sub = document.createElement("div");
          sub.className = "line-kana";
          sub.textContent = kana;
          span.appendChild(sub);
        }

        elLines.appendChild(span);
      });

      badge.textContent = clockwise ? "外回り（時計回り）" : "内回り（反時計回り）";
      document.getElementById("dirText").textContent = clockwise ? "外回り" : "内回り";
    }

    function next(){
      // 音は必ずユーザー操作（クリック）に紐づけて鳴らす
      playDepartSound();

      idx = clockwise
        ? (idx + 1) % yamanote.length
        : (idx - 1 + yamanote.length) % yamanote.length;

      render();
    }

    function random(){
      playDepartSound();

      let n = Math.floor(Math.random() * yamanote.length);
      if (n === idx) n = (n + 1) % yamanote.length;
      idx = n;

      render();
    }

    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("randomBtn").addEventListener("click", random);
    document.getElementById("dirToggle").addEventListener("change", (e)=>{
      // チェックON=内回り、OFF=外回り
      clockwise = !e.target.checked;
      render();
    });

    // PWA: Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
    }

    render();
  </script>
</body>
</html>
